# LLMUserEncoder

This is a part of ReSys research aimed at calculating user's embeddings based on their interactions with items using LLM capability.

## Installation

1. Clone the repository:
    ```sh
    git clone https://github.com/yourusername/LLMUserEncoder.git
    cd LLMUserEncoder
    ```

2. Create a virtual environment and activate it:
    ```sh
    python -m venv venv
    source venv/bin/activate  # On Windows use `venv\Scripts\activate`
    ```

3. Install the required dependencies:
    ```sh
    pip install -r requirements.txt
    ```

## Usage

### Preparing the Dataset

Ensure that your dataset is placed in the folder specified by the `--folder` argument. The default folder is `data/ml-1m`.

### Add OpanAI API key

To use the OpenAI API, you need to add your API key to the `token.yaml` file. 
You can find the `token.yaml` file in the root directory of the project. Add your API key to the file as shown below:

```yaml
openai: "YOUR_API_KEY"
```

### Running the Script

To evaluate embeddings for users in the dataset, run the `encode.py` script with the following command:

```sh
python encode.py --folder <path_to_dataset_folder> --agent <agent_name> --result-folder <path_to_result_folder> [--test]
```
### Arguments

- `--folder` or `-f`: The folder containing the dataset. Default is `data/ml-1m`.
- `--agent` or `-a`: The agent for the LLM model. Only `openai` is supported. Default is `openai`.
- `--result-folder` or `-r`: The folder for the results JSON. Default is `embeddings`.
- `--test` or `-t`: Test mode. Only generate descriptions without LLM calls.

### Example

```sh
python encode.py --folder data/ml-1m --agent openai --result-folder embeddings --test
```

This command will process the dataset in `data/ml-1m`, use the `openai` agent, and save the results in the `embeddings` folder. The `--test` flag indicates that only descriptions will be generated without making LLM calls.

### Output

The script will generate two JSON files in the specified result folder:

- `description.json`: Contains the user descriptions and embeddings.
- `errors.json`: Contains any errors that occurred during processing.

#### `description.json` Schema

The `description.json` file contains an array of user objects. Each user object has the following structure:

- `id` (int): The unique identifier for the user.
- `gender` (str): User's gender according to original dataset
- `age` (int): User's age category according to original dataset
- `rankings` (list[dict[str, int]]): List of dictionaries containing the item ID and rating given by the user.
- `description` (str): The description of the user generated by the LLM.
- `embedding` (list[float], optional): The embedding vector for the user description. This field is empty if the `--test` flag is not used.

#### Example

```json
[
  {
    "id": 1,
    "gender": "F",
    "age": 1,
    "rankings": {
      "One Flew Over the Cuckoo's Nest (1975)": 5,
      "James and the Giant Peach (1996)": 3,
      "My Fair Lady (1964)": 3,
      "Erin Brockovich (2000)": 4,
      "Bug's Life, A (1998)": 5,
      "Princess Bride, The (1987)": 3,
      "Ben-Hur (1959)": 5,
      "Christmas Story, A (1983)": 5,
      "Snow White and the Seven Dwarfs (1937)": 4,
      "Wizard of Oz, The (1939)": 4,
      "Beauty and the Beast (1991)": 5,
      "Gigi (1958)": 4,
      "Miracle on 34th Street (1947)": 4,
      "Ferris Bueller's Day Off (1986)": 4,
      "Sound of Music, The (1965)": 5,
      "Airplane! (1980)": 4,
      "Tarzan (1999)": 3,
      "Bambi (1942)": 4,
      "Awakenings (1990)": 5,
      "Big (1988)": 4,
      "Pleasantville (1998)": 3,
      "Wallace & Gromit: The Best of Aardman Animation (1996)": 3,
      "Back to the Future (1985)": 5,
      "Schindler's List (1993)": 5,
      "Meet Joe Black (1998)": 3,
      "Pocahontas (1995)": 5,
      "E.T. the Extra-Terrestrial (1982)": 4,
      "Titanic (1997)": 4,
      "Ponette (1996)": 4,
      "Close Shave, A (1995)": 3,
      "Antz (1998)": 4,
      "Girl, Interrupted (1999)": 4,
      "Hercules (1997)": 4,
      "Aladdin (1992)": 4,
      "Mulan (1998)": 4,
      "Hunchback of Notre Dame, The (1996)": 4,
      "Last Days of Disco, The (1998)": 5,
      "Cinderella (1950)": 5,
      "Sixth Sense, The (1999)": 4,
      "Apollo 13 (1995)": 5,
      "Toy Story (1995)": 5,
      "Rain Man (1988)": 5,
      "Driving Miss Daisy (1989)": 4,
      "Run Lola Run (Lola rennt) (1998)": 4,
      "Star Wars: Episode IV - A New Hope (1977)": 4,
      "Mary Poppins (1964)": 5,
      "Dumbo (1941)": 5,
      "To Kill a Mockingbird (1962)": 4,
      "Saving Private Ryan (1998)": 5,
      "Secret Garden, The (1993)": 4,
      "Toy Story 2 (1999)": 4,
      "Fargo (1996)": 4,
      "Dead Poets Society (1989)": 4
    },
    "description": "Based on the user's movie ratings, it seems the user has a wide range of preferences when it comes to the release year of the movies. The user enjoys classics such as \"Snow White and the Seven Dwarfs\" from 1937, as well as more modern films like \"Girl, Interrupted\" from 1999. However, it is notable that the user tends to rate higher the movies from the latter half of the 20th century and the beginning of the 21st century with notable exceptions of early Disney classics and a few select classic films like \"Ben-Hur\" and \"To Kill a Mockingbird.\"\n\nIn terms of genres and plot twists, the user appears to have a preference for family-friendly films, as evidenced by their enjoyment of animated movies such as \"Aladdin,\" \"Beauty and the Beast,\" and \"Toy Story.\" The user also seems to enjoy dramas and historical films, given the high ratings for movies like \"Schindler's List,\" \"Saving Private Ryan,\" and \"To Kill a Mockingbird.\" While most of the movies are generally positively rated by the user, it is interesting to note that the user gave lower ratings to some comedies and fantasy films such as \"James and the Giant Peach\" and \"Princess Bride.\"\n\nWhen it comes to cast and directors, the user seems to appreciate movies featuring strong ensemble casts with acclaimed actors such as Tom Hanks in \"Apollo 13\" and \"Toy Story,\" as well as Meryl Streep in \"The Sound of Music\" and \"Sophie's Choice.\" The user also seems to enjoy movies directed by well-known directors like Steven Spielberg (\"Schindler's List,\" \"E.T.\"), Rob Reiner (\"The Princess Bride,\" \"A Few Good Men\"), and Ron Howard (\"Apollo 13,\" \"A Beautiful Mind\").\n\nThere is a correlation between the user's rankings and critical acclaim for most movies. The user consistently rates highly acclaimed and award-winning films like \"Schindler's List,\" \"One Flew Over the Cuckoo's Nest,\" and \"The Sound of Music\" with high scores. This indicates that the user values movies that are well-received by critics and audiences alike, suggesting a discerning taste in films.\n\nThe user seems to have a generally positive attitude towards most movies, with very few receiving low ratings of 3 and below. The movies that did receive lower ratings tend to be more niche or less mainstream films like \"James and the Giant Peach\" and \"Pleasantville.\" These movies may have elements that do not align with the user's preferences, such as darker themes or unconventional storytelling.\n\nBased on the user's preferences, it is likely that they would enjoy movies with strong performances from actors like Tom Hanks, Meryl Streep, and Robin Williams, as well as films directed by Steven Spielberg, Rob Reiner, and Ron Howard. The user may also appreciate a mix of genres including dramas, historical films, animated movies, and classic tales with a modern twist.",
    "embedding": [
      -0.02609391324222088,
      0.013053428381681442, 
      ...,
      -0.020165830850601196
    ]
  }
]
```
